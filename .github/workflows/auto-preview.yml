# Creates/Updates a Shopify theme and adds the preview link within the PR description and as a comment
# The first time the theme is created, event .json files within the /templates folder are pushed to the theme
# Subsequte updates to an existing theme does not push any .json files within the /templates folder
#
# @devs For notes on creating composite actions: https://docs.github.com/en/actions/creating-actions/creating-a-composite-action
name: "Auto Preview"
on:
  push:
env:
  GH_TOKEN: ${{ github.token }}
  SHOPIFY_FLAG_STORE: ${{ secrets.SHOPIFY_DEV_STORE_URL }}
  SHOPIFY_CLI_THEME_TOKEN: ${{ secrets.STAGING_SHOP_ACCESS_TOKEN }}
  SHOPIFY_CLI_TTY: 0 # https://shopify.dev/docs/themes/tools/cli/ci-cd#step-2-integrate-shopify-cli-into-your-pipeline TODO when there is a theme limit, the following should stop interactive prompts but it doesn't seem to work

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  job-github-create-update-comment:
    runs-on: ubuntu-latest
    timeout-minutes: 3 # Increase threshold for projects that have a larger build time

    steps:
      - uses: actions/checkout@v3

      - id: preview-link
        uses: actions/shopify-theme-previw@v1
        with:
          shopify_flag_store: ${{ env.SHOPIFY_FLAG_STORE }}
          shopify_cli_theme_token: ${{ env.SHOPIFY_CLI_THEME_TOKEN }}

      - name: DEBUG Variables
        run: |
          echo ${{ env.JSON_RESPONSE }}
          echo ${{ env.THEME_ID }}
          echo ${{ env.PREVIEW_URL }}
          echo ${{ env.EDITOR_URL }}
          echo ${{ env.HAS_PREVIEW_LINK }}
          echo ${{ github.event_name }}
          echo ${{ github.event.action }}
          echo ${{ github.workflow }}
          echo ${{ github.ref }}
          echo ${{ steps.fc.outputs.comment-id }}
          echo ${{ github.event.pull_request.number }}
